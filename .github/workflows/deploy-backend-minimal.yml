name: Deploy Backend to AKS (Minimal Cost)

on:
  push:
    branches: [main, master]
    paths:
      - 'backend/**'
      - 'k8s-minimal/**'
      - '.github/workflows/deploy-backend-minimal.yml'
  workflow_dispatch:

env:
  AZURE_CONTAINER_REGISTRY: ecommercetest2025 # æ›¿æ¢ä¸ºä½ çš„ACRåç§°
  CONTAINER_NAME: ecommerce-backend
  RESOURCE_GROUP: E-commerce # æµ‹è¯•èµ„æºç»„
  CLUSTER_NAME: ecommerce-test-aks # æµ‹è¯•é›†ç¾¤å

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check if AKS cluster is running
        id: check-aks
        run: |
          STATUS=$(az aks show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }} --query "powerState.code" --output tsv)
          echo "AKS Status: $STATUS"
          if [ "$STATUS" != "Running" ]; then
            echo "ğŸš€ å¯åŠ¨AKSé›†ç¾¤..."
            az aks start --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }}
            echo "â³ ç­‰å¾…é›†ç¾¤å¯åŠ¨..."
            sleep 60
          fi

      - name: Login to Azure Container Registry
        run: |
          az acr login --name ${{ env.AZURE_CONTAINER_REGISTRY }}

      - name: Build and push Docker image
        run: |
          cd backend
          docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME }}:${{ github.sha }} .
          docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME }}:latest .
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME }}:${{ github.sha }}
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME }}:latest

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }}

      - name: Update deployment image
        run: |
          sed -i 's|your-acr.azurecr.io/ecommerce-backend:latest|${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_NAME }}:${{ github.sha }}|g' k8s-minimal/deployment-minimal.yaml

      - name: Deploy to AKS
        run: |
          kubectl apply -f k8s-minimal/deployment-minimal.yaml

          # ç­‰å¾…æ•°æ®åº“éƒ¨ç½²å®Œæˆ
          echo "ç­‰å¾…æ•°æ®åº“éƒ¨ç½²..."
          kubectl rollout status deployment/postgres-deployment -n ecommerce --timeout=300s
          kubectl rollout status deployment/mongo-deployment -n ecommerce --timeout=300s

          # ç­‰å¾…åç«¯éƒ¨ç½²å®Œæˆ
          echo "ç­‰å¾…åç«¯éƒ¨ç½²..."
          kubectl rollout status deployment/backend-deployment -n ecommerce --timeout=600s

      - name: Verify deployment
        run: |
          echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€ï¼š"
          kubectl get pods -n ecommerce
          kubectl get services -n ecommerce

          echo "ğŸ” æ£€æŸ¥ Pod è¯¦æƒ…ï¼š"
          kubectl describe pods -n ecommerce -l app=backend

          echo "ğŸ“‹ æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š"
          kubectl logs -n ecommerce -l app=backend --tail=50 || echo "æš‚æ— æ—¥å¿—"

          echo "ğŸ”— è·å–å¤–éƒ¨è®¿é—®åœ°å€ï¼š"
          kubectl get service backend-service -n ecommerce -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "LoadBalancer IP è¿˜æœªåˆ†é…"

      - name: Optional - Schedule cluster shutdown
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ’¡ æç¤ºï¼šä¸ºèŠ‚çœæˆæœ¬ï¼Œè¯·è€ƒè™‘åœ¨ä¸ä½¿ç”¨æ—¶å…³é—­é›†ç¾¤"
          echo "å…³é—­å‘½ä»¤: az aks stop --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }}"
          echo "å¯åŠ¨å‘½ä»¤: az aks start --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CLUSTER_NAME }}"
